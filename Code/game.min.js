let p1_hand=[],p2_hand=[],p1_point=0,p2_point=0,p1_selected_card=[],p2_selected_card=[];const card_num=8;let WIN_POINT=250,WIN_TURN=10,dropped_cards_p1=[],dropped_cards_p2=[],turn="p1",time="game",numTurn=1,p1_is_acting=!1;const elementToNumber={H:1,He:2,Li:3,Be:4,B:5,C:6,N:7,O:8,F:9,Ne:10,Na:11,Mg:12,Al:13,Si:14,P:15,S:16,Cl:17,Ar:18,K:19,Ca:20,Fe:26,Cu:29,Zn:30,I:53},elements=[...Array(6).fill("H"),...[,,,,].fill("O"),...[,,,,].fill("C"),"He","Li","Be","B","N","F","Ne","Na","Mg","Al","Si","P","S","Cl","Ar","K","Ca","Fe","Cu","Zn","I"],element=["H","O","C","He","Li","Be","B","N","F","Ne","Na","Mg","Al","Si","P","S","Cl","Ar","K","Ca","Fe","Cu","Zn","I"];let deck=[...elements,...elements],materials=[],imageCache={},model,modelName;const countTemplate=Object.fromEntries(Object.values(elementToNumber).map(e=>[e,0]));function convertToCount(){let e={...countTemplate};return dropped_cards_p2.forEach(t=>{let n=elementToNumber[t];void 0!==n&&(e[n]+=1)}),Object.values(e)}let xs=[],ys=[],isTraining=!1;function extractModelName(e){let t=e.match(/\/([^\/]+)$/);return t?t[1]:null}async function loadModel(e=null,t=null){try{if(null==e){let n=await tf.io.listModels();modelName="standardModel",n["indexeddb://standardModel"]?(model=await tf.loadLayersModel("indexeddb://standardModel"),console.log("ローカルの学習済みモデルをロードしました")):(model=await tf.loadLayersModel("https://kurorosuke.github.io/AI_models/model1/model.json"),console.log("サーバーからモデルをロードしました"),await saveModel())}else{let l=await tf.io.listModels();modelName=null==t?extractModelName(e):t,console.log(modelName),l[`indexeddb://${modelName}`]?(model=await tf.loadLayersModel(`indexeddb://${modelName}`),console.log("ローカルの学習済みモデルをロードしました")):(console.log(`${e}/model.json`),model=await tf.loadLayersModel(`${e}/model.json`),console.log("サーバーからモデルをロードしました")),await saveModel()}addOptions(),document.getElementById("Attention").style.display="none"}catch(a){console.error("モデルのロードに失敗しました",a),document.getElementById("Attention").style.display="block"}}async function addTrainingData(e,t,n){if(!model){console.log("モデルがロードされていません");return}var l=await convertToCount(e),a=l.reduce(function(e,t){return e+t},0);l.push(n),l.push(2*a+Number(!n)+1),console.log("学習用データ:",l);let i=tf.tensor2d([l],[1,26]),d=tf.tensor2d([oneHotEncode(t,model.outputShape[1])],[1,model.outputShape[1]]);xs.push(i),ys.push(d),console.log("データを追加しました: クラス",t)}function cosineSimilarity(e,t){let n=0,l=0,a=0;for(let i=0;i<e.length;i++)n+=e[i]*t[i],l+=e[i]**2,a+=t[i]**2;return l=Math.sqrt(l),a=Math.sqrt(a),l&&a?n/(l*a):0}function findClosestMaterial(e){let t=null,n=-1;return materials.forEach((l,a)=>{let i=cosineSimilarity(e,Object.values(l.d));i>n&&(n=i,t={index:a,similarity:i})}),t}async function trainModel(){if(!model||0===xs.length){console.log("学習データが不足しています");return}if(isTraining){console.log("現在学習中です...");return}if(isTraining=!0,console.log("モデルの追加学習を開始..."),model.compile({optimizer:tf.train.adam(.002),loss:"categoricalCrossentropy",metrics:["accuracy"]}),console.log("model.outputShape:",model.outputShape),!model.outputShape||model.outputShape.length<2){console.error("モデルの outputShape が不正です:",model.outputShape);return}let e=tf.concat(xs),t=tf.concat(ys);await model.fit(e,t,{epochs:3,batchSize:32,callbacks:{onEpochEnd(e,t){console.log(`Epoch ${e+1}: Loss = ${t.loss.toFixed(4)}, Accuracy = ${t.acc.toFixed(4)}`)}}}),console.log("手札に最も近い物質のデータを追加学習...");let n=[],l=[],a=model.outputShape[1]||(materials?materials.length:10);if(!a||isNaN(a)){console.error("numClasses が不正です:",a),isTraining=!1;return}if(xs.forEach((e,t)=>{let i=findClosestMaterial(e.dataSync());if(!i){console.warn(`手札 ${t} に対応する近い物質が見つかりません。スキップします。`);return}let d=i.index;console.log(`学習対象: 手札 ${t} → 近い物質: materials[${d}]`);let o=oneHotEncode(d,a);l.push(tf.tensor2d([o],[1,a])),n.push(e)}),0===n.length||0===l.length){console.warn("追加学習用のデータが不足しているため、スキップします。"),isTraining=!1;return}let i=tf.concat(n),d=tf.concat(l);model.compile({optimizer:tf.train.adam(.001),loss:"categoricalCrossentropy",metrics:["accuracy"]}),await model.fit(i,d,{epochs:1,batchSize:32,callbacks:{onEpochEnd(e,t){console.log(`Epoch ${e+1}: Loss = ${t.loss.toFixed(4)}, Accuracy = ${t.acc.toFixed(4)}`)}}}),console.log("モデルの追加学習が完了しました"),e.dispose(),t.dispose(),i.dispose(),d.dispose(),xs=[],ys=[],isTraining=!1,await saveModel()}function CanCreateMaterial(e){console.log(e);let t=e.d,n={},l=new Set([...dropped_cards_p1,...dropped_cards_p2,...p1_hand]);for(let a in(l=deck.filter(e=>!l.has(e))).forEach(e=>{n[e]=(n[e]||0)+1}),t)if(!n[a]||n[a]<t[a])return!0;return!1}function getUsedMaterials(){let e=localStorage.getItem("materials");return e&&"{}"!==e?Object.fromEntries(Object.entries(JSON.parse(e)).filter(([e,t])=>t>0)):(console.log("No valid materials data found."),{})}function calculatePseudoProbabilities(e){let t=Object.values(e).reduce((e,t)=>e+t,0);if(0===t)return{};let n={};for(let l in e)n[l]=e[l]/t;return n}function calculateWeightedProbabilities(e,t){let n={};for(let l in t)e.hasOwnProperty(l)?(sumNs=new Int8Array(localStorage.getItem("sumNs")),n[l]=(e[l]*sumNs/(sumNs+10)+t[l])/2):n[l]=t[l];return n}async function runModel(e,t){if(!model){console.log("モデルがロードされていません");return}var n=await convertToCount(),l=n.reduce(function(e,t){return e+t},0);n.push(e),n.push(2*l+Number(!e)+1),n=tf.tensor2d([n],[1,26]);let a=model.predict(n),i=await a.data(),d=calculateWeightedProbabilities(pseudoProbability=calculatePseudoProbabilities(recordCreatedMaterials=getUsedMaterials()),i),o=Object.entries(d).sort((e,t)=>t[1]-e[1]);ShowMaterials=o.slice(0,3);let r=o.findIndex(([e])=>e==t)+1;ShowMaterials.push([t,d[t]]);let s=document.getElementById("predictTable").getElementsByTagName("tbody")[0];s.innerHTML="";let c=["1位","2位","3位",`${r}位`];ShowMaterials.forEach(([e,t],n)=>{if(null!=materials[e]){let l=s.insertRow(),a=l.insertCell(0),i=l.insertCell(1),d=l.insertCell(2);a.innerHTML=c[n],i.innerHTML=materials[e].a,d.innerHTML=(100*t).toFixed(2)+"%"}}),document.getElementById("predictResultContainer").style.display="inline";var p=Math.max(...Object.values(d)),m=Object.keys(d).find(e=>d[e]===p);console.log(m),console.log(materials[m]);try{for(;await CanCreateMaterial(materials[m]);){if(delete d[m],0===Object.keys(d).length){console.log("作成できる候補がありません");return}var p=Math.max(...Object.values(d)),m=Object.keys(d).find(e=>d[e]===p);return console.log(`推論結果: クラス ${m}, 信頼度: ${p}`),document.getElementById("predictResult").innerHTML=`予測結果：${materials[m].a}・信頼度：${p}`,{predictedClass:m,confidence:p}}}catch{console.log(materials[m]),null==materials[m]&&console.log("モデルと化合物のバージョンが異なります")}}async function saveModel(){if(!model){console.log("モデルがロードされていません");return}try{console.log(modelName),console.log(`indexeddb://${modelName}`),await model.save(`indexeddb://${modelName}`),console.log("学習済みモデルを IndexedDB に保存しました")}catch(e){console.error("モデルの保存に失敗しました",e)}}function oneHotEncode(e,t){let n=Array(t).fill(0);return n[e]=1,n}async function loadMaterials(e){try{let t=await fetch(e),n=await t.json();if(!n.material||!Array.isArray(n.material))return document.getElementById("Attention2").style.display="inline",[];return document.getElementById("Attention2").style.display="none",n.material}catch(l){return console.error("Error fetching compounds:",l),document.getElementById("Attention2").style.display="inline",[]}}async function view_p2_hand(){let e=document.getElementById("p2_hand");p2_hand.forEach((t,n)=>{let l=document.createElement("img");l.src=imageCache[elementToNumber[t]].src,l.alt=t,l.style.padding="5px",l.style.border="1px solid #000",l.classList.add("selected"),l.classList.toggle("selected"),l.addEventListener("click",function(){let e=document.getElementById("ron_button");if(e.style.display="none","make"==time&&(this.classList.toggle("selected"),this.classList.contains("selected")?p2_selected_card.splice(p2_selected_card.indexOf(this.alt),1):p2_selected_card.push(this.alt)),"p2"==turn&&"game"==time){dropped_cards_p2.push(this.alt);let t=document.createElement("img");t.alt=this.alt,t.src=imageCache[elementToNumber[this.alt]].src,t.style.border="1px solid #000",document.getElementById("dropped_area_p2").appendChild(t),this.classList.remove("selected"),this.classList.add("selected"),this.classList.toggle("selected");let l=drawCard();this.src=imageCache[elementToNumber[l]].src,this.alt=l,this.style.padding="5px",this.style.border="1px solid #000",p2_hand[n]=l,turn="p1","none"!=document.getElementById("hintContainer").style.display&&document.getElementById("hint_button").click(),setTimeout(()=>{p1_action()},500)}}),e.appendChild(l)})}async function view_p1_hand(){let e=document.getElementById("p1_hand");p1_hand.forEach((t,n)=>{let l=document.createElement("img");l.src=imageCache[0].src,l.alt="相手の手札",l.style.padding="5px",l.style.border="1px solid #000",l.classList.add("selected"),l.classList.toggle("selected"),e.appendChild(l)})}async function search(e){return materials.find(t=>{for(let n in e)if(!t.d[n]||t.d[n]!==e[n])return!1;for(let l in t.d)if(!e[l])return!1;return!0})||materials[0]}async function p1_make(e){let t=await search_materials(arrayToObj(p1_hand));return t&&0!==t.length?(t.sort((e,t)=>t.c-e.c),t):[{a:"なし",b:"なし",c:0,d:{},e:[]}]}async function p2_make(){document.getElementById("generate_button").style.display="none";let e=document.getElementById("done_button");e.style.display="inline",e.replaceWith(e.cloneNode(!0));let t=document.getElementById("done_button");return new Promise(e=>{t.addEventListener("click",function(){document.getElementById("hintContainer").style.display="none";let t=search(arrayToObj(p2_selected_card));e(t)})})}async function get_dora(){return element[Math.round(23*Math.random())]}async function incrementMaterialCount(e){let t=localStorage.getItem("materials"),n=t?JSON.parse(t):{};n[e]=(n[e]||0)+1,localStorage.setItem("materials",JSON.stringify(n));var l=new Int8Array(localStorage.getItem("sumNs"));localStorage.setItem("sumNs",l+1)}async function done(e,t=!1){document.getElementById("ron_button").style.display="none",document.getElementById("hint_button").style.display="none",document.getElementById("hintContainer").style.display="none";let n=await p2_make();console.log(n.f),predictedMaterialP2=await runModel("p1"==e?0:1,madeMaterialNum=n.f);let l=await p1_make(predictedMaterialP2);dora=await get_dora(),console.log(`ドラ: ${dora}`);let a=n.c,i=l[0].c;Boolean(n.e.includes(l[0].b))?a*=1.5+Math.random()/2:Boolean(l[0].e.includes(n.b))&&(i*=1.5+Math.random()/2),Boolean(Object.keys(n.d).includes(dora))?a*=1.5:Boolean(Object.keys(l[0].d).includes(dora))&&(i*=1.5),t&&("p2"==e?a/=1.2:i/=1.2),"p2"==e?i/=1.5:a/=1.5,a=Math.round(a),p1_point+=await (i=Math.round(i)),p2_point+=await a,document.getElementById("p2_point").innerHTML+=`+${a}`,document.getElementById("p1_point").innerHTML+=`+${i}`,document.getElementById("p2_explain").innerHTML=`生成物質：${n.a}, 組成式：${n.b}`,document.getElementById("p1_explain").innerHTML=`生成物質：${l[0].a}, 組成式：${l[0].b}`;let d;await addTrainingData(convertToCount(dropped_cards_p2),n.f,"p1"==e?0:1),await trainModel(),await incrementMaterialCount(n.a);let o=await win_check();document.getElementById("done_button").style.display="none";let r=document.getElementById("nextButton");r.style.display="inline",o?(console.log("ゲーム終了"),r.textContent="ラウンド終了",r.addEventListener("click",function(){returnToStartScreen(),p1_point=0,p2_point=0,numTurn=0,resetGame(),r.style.display="none";let e=r.cloneNode(!0);r.parentNode.replaceChild(e,r)})):(console.log("次のゲーム"),numTurn+=1,r.textContent="次のゲーム",r.addEventListener("click",function(){document.getElementById("predictResultContainer").style.display="none",resetGame(),r.style.display="none";let e=r.cloneNode(!0);r.parentNode.replaceChild(e,r)}))}async function win_check(){return Math.abs(p1_point-p2_point)>=WIN_POINT?p1_point>p2_point?"p1":"p2":numTurn>=WIN_TURN?p1_point>p2_point?"p1":"p2":null}async function p1_exchange(e){dropped_cards_p1.push(p1_hand[e]);var t=p1_hand[e];if(!p1_hand[e]){console.error("Invalid target element in p1_hand.");return}let n=document.createElement("img");n.src=imageCache[elementToNumber[p1_hand[e]]].src,n.style.border="1px solid #000",n.style.padding="5px",document.getElementById("dropped_area_p1").appendChild(n);let l=document.querySelectorAll("#p1_hand img")[e];if(!l){console.error("Image element not found in p1_hand.");return}let a=drawCard();p1_hand[e]=a,l.src=imageCache[0].src,l.alt=a,l.style.padding="5px",l.style.border="1px solid #000",l.classList.remove("selected"),l.classList.add("selected"),l.classList.toggle("selected"),turn="p2",checkRon(t)}async function p1_action(){if("p1"!==turn||p1_is_acting)return;p1_is_acting=!0;let e=materials.filter(e=>e.c>20),t=e.sort((e,t)=>{let n=Object.keys(e.d).reduce((t,n)=>t+Math.min(p1_hand.filter(e=>e===n).length,e.d[n]),0);return Object.keys(t.d).reduce((e,n)=>e+Math.min(p1_hand.filter(e=>e===n).length,t.d[n]),0)-n||t.c-e.c}),n=t[0];if(n){let l=!0;for(let a in n.d)if(!p1_hand.includes(a)||p1_hand.filter(e=>e===a).length<n.d[a]){l=!1;break}if(l&&n.c>20)time="make",await done("p1");else{let i=p1_hand.filter(e=>!(e in n.d)||p1_hand.filter(t=>t===e).length>n.d[e]);if(i.length>0){let d=i[Math.floor(Math.random()*i.length)];p1_exchange(p1_hand.indexOf(d))}else time="make",done("p1")}}else p1_exchange(Math.floor(Math.random()*p1_hand.length));turn="p2",p1_is_acting=!1}function arrayToObj(e){let t={};return e.forEach(e=>{t[e]?t[e]++:t[e]=1}),t}function shuffle(e){let t=e.length;for(;0!=t;){let n=Math.floor(Math.random()*t);t--,[e[t],e[n]]=[e[n],e[t]]}return e}function drawCard(){return deck.length>0?deck.pop():(time="make",done("no-draw"))}async function search_materials(e){return materials.filter(t=>{for(let n in t.d)if(!e[n]||t.d[n]>e[n])return!1;return!0})}function random_hand(){for(let e=0;e<8;e++)p1_hand.push(drawCard()),p2_hand.push(drawCard())}function resetGame(){p1_hand=[],p2_hand=[],dropped_cards_p1=[],dropped_cards_p2=[],p1_selected_card=[],p2_selected_card=[],time="game",turn=.5>=Math.random()?"p1":"p2",numTurn=1,document.getElementById("p1_point").innerHTML=`ポイント：${p1_point}`,document.getElementById("p1_explain").innerHTML="　",document.getElementById("p2_point").innerHTML=`ポイント：${p2_point}`,document.getElementById("p2_explain").innerHTML="　",document.getElementById("predictResult").innerHTML="　",document.getElementById("generate_button").style.display="inline",document.getElementById("done_button").style.display="none",document.getElementById("nextButton").style.display="none",deck=shuffle(deck=[...elements,...elements]);let e=document.getElementById("p1_hand"),t=document.getElementById("p2_hand");e.innerHTML="",t.innerHTML="";let n=document.getElementById("dropped_area_p1"),l=document.getElementById("dropped_area_p2");n.innerHTML="",l.innerHTML="",random_hand(),view_p1_hand(),view_p2_hand(),document.getElementById("hint_button").style.display="inline","p1"===turn&&setTimeout(()=>p1_action(),500)}function preloadImages(){[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,26,29,30,53].forEach(e=>{let t=new Image;t.src=`../images/${e}.webp`,imageCache[e]=t})}async function init_json(){materials=await loadMaterials("https://kurorosuke.github.io/compounds/obf_standard_min.json")}async function checkRon(e){let t=await search_materials(arrayToObj([...p2_hand,e])),n=t.filter(t=>t.d[e]);if(n.length>0){let l=document.getElementById("ron_button");l.style.display="inline",l.replaceWith(l.cloneNode(!0));let a=document.getElementById("ron_button");a.addEventListener("click",function(){a.style.display="none",document.getElementById("hintContainer").style.display="none",document.getElementById("hint_button").style.display="none";let t=document.querySelectorAll("#dropped_area_p1 img"),n=t[t.length-1];n.style.border="5px solid red",n.style.padding="1px",p2_selected_card=[e],time="make";let l=document.getElementById("dropped_area_p1").children,i=l[l.length-1];i.style.border="1px solid f00",done("p2",!0)})}let i=await search_materials(arrayToObj([...p1_hand,e])),d=i.filter(t=>t.c>=70&&t.d[e]);d.length>0&&(p1_hand.push(e),p1_selected_card=[e],time="make",done("p1",!0))}function updateGeneratedMaterials(e){if(!e||"なし"===e)return;let t=JSON.parse(localStorage.getItem("generatedMaterials"))||{};t[e]?t[e]+=1:t[e]=1,localStorage.setItem("generatedMaterials",JSON.stringify(t))}function openWinSettings(){document.getElementById("winSettingsModal").style.display="block"}async function saveWinSettings(){let e=parseInt(document.getElementById("winPointInput").value,10),t=parseInt(document.getElementById("winTurnInput").value,10);if(isNaN(e)||e<1){alert("WIN_POINT は 1 以上の数値を入力してください。");return}if(isNaN(e)||e>999){alert("WIN_POINT の最大値は 999 です。");return}if(isNaN(t)||t<1){alert("WIN_TURN は 1 以上の数値を入力してください。");return}let n=document.getElementById("compoundsSelection").value;if("url"!=n)var l=`https://kurorosuke.github.io/compounds/${n}.json`;else var l=document.getElementById("compoundsURL").value;materials=await loadMaterials(l),WIN_POINT=e,WIN_TURN=t,closeWinSettings()}function closeWinSettings(){document.getElementById("winSettingsModal").style.display="none"}async function findMostPointMaterial(){let e=await search_materials(arrayToObj(p2_hand));if(0===e.length)console.log("p2_hand 内で作成可能な物質はありません。");else{let t=e.reduce((e,t)=>t.c>e.c?t:e,e[0]);console.log(`p2_hand 内で最もポイントが高い物質: ${t.a} (ポイント: ${t.c})`)}}function initializeMaterials(){if(!localStorage.getItem("materials")){let e={};materials.forEach(t=>{e[t.a]=0}),localStorage.setItem("materials",JSON.stringify(e))}localStorage.getItem("sumNs")||localStorage.setItem("sumNs",0)}function addInputModelDiv(){let e=document.createElement("div");e.id="_inputDiv";let t=document.createElement("input");t.id="inputTag",t.placeholder="新しいモデルのURLを入力";let n=document.createElement("button");n.innerHTML="追加",n.id="inputButton",n.onclick=function(){let e=document.getElementById("inputTag");console.log(e.value),getModelNames().then(t=>{do null==(userInput=prompt("名前を入力してください:"))&&(userInput=extractModelName(url));while(t.includes(userInput));loadModel(e.value,userInput),e.value=""})},e.appendChild(t),e.appendChild(n),document.getElementById("modelModals").appendChild(e)}function addLoadingButton(){let e=document.createElement("div");e.id="loadingModelButtonDiv",e.style.border="2px solid black",e.style.width="90%",e.style.height="5%",e.style.textAlign="center";let t=document.createElement("label");t.id="NewModelOptionButton",t.innerHTML="モデルのJSONファイルを選択",t.onclick=function(){document.getElementById("loadingModelButton").click()};let n=document.createElement("input");n.innerHTML="読込",n.id="loadingModelButton",n.type="file",n.accept=".json",n.style.display="none",document.getElementById("Attention3").style.display="none",n.addEventListener("change",async e=>{let t=e.target.files,n=Array.from(t).find(e=>e.name.endsWith(".json")),l=Array.from(t).filter(e=>e.name.endsWith(".bin")),a=await getModelNames();do userInput=prompt("使われていない名前を入力してください:");while(a.includes(userInput));modelName=userInput,model=await tf.loadLayersModel(tf.io.browserFiles([n,...l])),await saveModel(),addOptions(),document.getElementById("loadingModelButton").value="",document.getElementById("loadingModelButton").placeholder="モデルのパスを選択してください",document.getElementById("Attention3").style.display="none"}),e.appendChild(n),e.appendChild(t),document.getElementById("modelModals").appendChild(e)}function returnToStartScreen(){document.getElementById("startScreen").style.display="flex",document.getElementById("p1_area").style.display="none",document.getElementById("dropped_area_p1").style.display="none",document.getElementById("dropped_area_p2").style.display="none",document.getElementById("p2_area").style.display="none",document.getElementById("gameRuleButton").style.display="block",document.getElementById("predictResultContainer").style.display="none"}function showRules(){document.getElementById("rulesModal").style.display="block"}function closeRules(){document.getElementById("rulesModal").style.display="none"}function showInputTag(){"url"==document.getElementById("compoundsSelection").value?document.getElementById("compoundsURL").style.display="inline":document.getElementById("compoundsURL").style.display="none"}function showModelInputTag(){"new"==document.getElementById("modelSelection").value?document.getElementById("modelURL").style.display="inline":document.getElementById("modelURL").style.display="none"}async function getModelNames(){try{let e=await tf.io.listModels(),t=Object.keys(e).map(e=>e.replace("indexeddb://",""));return t}catch(n){return console.error("モデル名の取得に失敗しました",n),[]}}async function addOptions(){let e=await getModelNames(),t=document.getElementById("modelModals"),n=[];if(t){let l=t.getElementsByTagName("div");for(let a of l)a.id&&n.push(a.id)}e.filter(e=>!n.includes(e)).forEach(e=>{let n=document.createElement("div");n.className="modelModal",n.id=e,n.text=e;let l=document.createElement("h3");l.textContent=e,n.appendChild(l);let a=document.createElement("p");getModelsDate(e).then(t=>{console.log(`Model: ${e}, Date: ${t}`),a.textContent=t||"未取得"});let i=document.createElement("button");i.textContent="選択",i.id=n.id,i.onclick=function(){selectModelOnSetting(this.id)};let d=document.createElement("button");d.textContent="削除",d.id=n.id,d.onclick=function(){removeModelOnSetting(this.id)};let o=document.createElement("button");o.textContent="初期化",o.onclick=function(){console.log("初期化が実行されました")};let r=document.createElement("button");r.textContent="保存",r.id=n.id,r.onclick=function(){downloadModel(this.id)},n.appendChild(l),n.appendChild(a),n.appendChild(i),n.appendChild(r),n.appendChild(d),n.appendChild(o),t.appendChild(n)})}function cosineSimilarity(e,t){let n=0,l=0,a=0;for(let i=0;i<e.length;i++)n+=e[i]*t[i],l+=e[i]**2,a+=t[i]**2;return l=Math.sqrt(l),a=Math.sqrt(a),l&&a?n/(l*a):0}function pseudoCosVec(e,t){let n=convertToVector(materials[e].d,element),l=convertToVector(materials[t].d,element);console.log(n,l);let a=cosineSimilarity(n,l);return a}function convertToVector(e,t){return t.map(t=>e[t]||0)}function showModelDetail(){addOptions(),document.getElementById("modelModals").style.display="inline",document.getElementById("buttonModal").style.display="inline",document.getElementById("overlay").style.display="inline"}document.getElementById("generate_button").addEventListener("click",function(){"p2"==turn&&(document.getElementById("hintContainer").style.display="none",document.getElementById("hint_button").style.display="none",time="make",document.getElementById("ron_button").style.display="none",done("p2"))}),document.getElementById("setting_icon").addEventListener("click",function(){document.getElementById("winSettingsModal").style.display="inline"}),document.addEventListener("DOMContentLoaded",function(){preloadImages(),init_json(),loadModel(),initializeMaterials(),deck=shuffle(deck=[...elements,...elements]),addInputModelDiv(),addLoadingButton(),random_hand(),view_p1_hand(),view_p2_hand(),"p1"==(turn=Math.random()>=.5?"p1":"p2")&&p1_action()}),document.getElementById("startButton").addEventListener("click",function(){document.getElementById("startScreen").style.display="none",document.getElementById("p1_area").style.display="block",document.getElementById("dropped_area_p1").style.display="block",document.getElementById("dropped_area_p2").style.display="block",document.getElementById("p2_area").style.display="block",document.getElementById("gameRuleButton").style.display="none",document.getElementById("predictResultContainer").style.display="none"}),document.getElementById("closeRulesButton").addEventListener("click",closeRules),window.onclick=function(e){let t=document.getElementById("rulesModal");e.target===t&&closeRules()};let selectingModel;function selectModelOnSetting(e){selectingModel=e;let t=document.querySelectorAll("#modelModals div");t.forEach(e=>{e.style.background="white"}),document.getElementById(e).style.background="pink"}function applyModalSetting(){document.getElementById("winSettingsModal").style.display="none",removeTarget.forEach(e=>{tf.io.removeModel(`indexeddb://${e}`)}),console.log(`this:${selectingModel}`),selectingModel&&(removeTarget.includes(selectingModel)?loadModel("https://kurorosuke.github.io/AI_models/model1"):loadModel("notNull",selectingModel)),closeModelModal()}let removeTarget=[];function removeModelOnSetting(e){console.log(e),removeTarget.push(e),document.getElementById(e).remove()}function closeModelModal(){removeTarget=[],document.getElementById("modelModals").style.display="none",document.getElementById("buttonModal").style.display="none",document.getElementById("overlay").style.display="none"}async function downloadModel(e){console.log(e);try{let t=await tf.loadLayersModel(`indexeddb://${e}`);await t.save(`downloads://${e}`),alert(`${e} をダウンロードしました`),console.log(`モデル ${e} をダウンロードフォルダに保存しました！`)}catch(n){console.error(`モデル ${e} のダウンロードに失敗しました`,n)}}function convertToVector2(e,t){let n=Array(t.length).fill(0);return e.forEach(e=>{let l=t.indexOf(e);-1!==l&&n[l]++}),n}function findClosestMaterials(e){let t=convertToVector2(e,element);return materials.map((e,n)=>{let l=Array(element.length).fill(0);for(let[a,i]of Object.entries(e.d)){let d=element.indexOf(a);-1!==d&&(l[d]=i)}return{index:n,similarity:cosineSimilarity(t,l)}}).sort((e,t)=>t.similarity-e.similarity).slice(0,3)}async function getModelsDate(e){try{let t=await tf.io.listModels();console.log("Models List:",t);let n=t[`indexeddb://${e}`];if(!n)return console.warn(`Model ${e} not found in IndexedDB.`),"N/A";return n.dateSaved?new Date(n.dateSaved).toLocaleString():n.lastModified?new Date(n.lastModified).toLocaleString():"N/A"}catch(l){return console.error(`Error fetching date for model ${e}:`,l),"N/A"}}document.getElementById("hint_button").addEventListener("click",function(){let e=findClosestMaterials(p2_hand),t=document.getElementById("hintTable").getElementsByTagName("tbody")[0];if(t.innerHTML="",0===e.length){let n=t.insertRow().insertCell(0);n.colSpan=3,n.innerHTML="近い物質が見つかりません",n.style.textAlign="center";return}e.forEach(e=>{let n=materials[e.index],l=t.insertRow(),a=l.insertCell(0),i=l.insertCell(1),d=l.insertCell(2);a.innerHTML=n.a,i.innerHTML=n.b,d.innerHTML=n.c}),document.getElementById("hintContainer").style.display="inline"});